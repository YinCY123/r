---
title: "Automated Data Collection With R"
author: "yincy"
date: "7/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 1 Introduction  
```{r}
library(stringr)
library(XML)
library(maps)
library(magrittr)
```

```{r}
heritage_page <- htmlParse(file = "files/List of World Heritage in Danger - Wikipedia.html", 
                           encoding = "UTF-8")


tables <- readHTMLTable(doc = heritage_page, stringsAsFactors = F)
danger_table <- tables[[2]]
colnames(danger_table) <- c("name", "image", "location", "criteria", "area", "year", "endangered", "reason", "refs")
```

```{r}
danger_table$criteria <- ifelse(grepl("Natural", danger_table$criteria), "nat", "cult")
danger_table$criteria %>% table()
```


```{r}
danger_table$year <- as.numeric(danger_table$year)
```


```{r}
l <- danger_table$endangered %>% nchar
danger_table$endangered <- substr(danger_table$endangered, l-4, l-1) %>% as.numeric()
```


```{r}
danger_table$location[1:3]
reg_y <- "[/][ -]*[[:digit:]]*[.]*[[:digit:]]*[;]"
reg_x <- "[;][ -]*[[:digit:]]*[.]*[[:digit:]]*"
```


```{r}
y_coords <- str_extract(string = danger_table$location, pattern = reg_y)
x_coords <- str_extract(string = danger_table$location, pattern = reg_x)
```

```{r}
y_coords <- str_extract(y_coords, "[-]?[[:digit:]]+[.]*[:digit:]*")
x_coords <- str_extract(x_coords, "[-]?[:digit:]+[.]*[:digit:]*")
```

```{r}
danger_table$y_coord <- y_coords
danger_table$x_coord <- x_coords

danger_table[, c("x_coord", "y_coord")]
```

```{r}
danger_table <- danger_table[, c("name", "criteria", "year", "endangered", "x_coord", "y_coord")]
```

```{r}
p <- ifelse(danger_table$criteria == "nat", 19, 2)
c <- ifelse(danger_table$criteria == "nat", "red", "blue")
map("world", col = "grey", lwd = 0.5, mar = rep(0.1, 4))
points(danger_table$x_coord, danger_table$y_coord, pch = p, col = c, cex = 0.7)
box(which = "figure", col = "grey", lwd = 0.1)
legend(x = -180, y = -85, 
       legend = c("natural", "cultural"), 
       col = c("red", "blue"), 
       pch = c(19, 2), 
       bty = "n", 
       xpd = TRUE)
```

```{r}
danger_table$yend <- cut(danger_table$endangered, breaks = seq(1985, 2020, 5))
danger_table$yend %>% table() %>% sort() %>% barplot()
```

```{r}
danger_table$endangered %>% hist()
```


**Technologies for disseminating, extracting, and storing web data**  
```{r}
knitr::include_graphics("technologies-for-disseminate-extracting-storing-web-data.PNG")
```


# Chapter 2 HTML  
An HTML file is basically nothing but plain text—it can be opened and edited with any text editor. What makes HTML so powerful is its marked up structure.  

The markup definitions rely on predefined character sequences—the tags—that enclose parts of the text.  

## Syntax rules  
### Tags, elements, and attributes  
Plain text is turned into an HTML document by tags that can be interpreted by a browser. The combination of start tag, content, and end tag is called *element*  
```
<title>First HTML</title>
```

### Reserved and special characters  
- character entities: `&;`  
```
the wrong format 
<p> 5 < 6 but 7 > 3 </p>

the right format
<p> 5$lt; 6 but 7 &gt; 3 </p>
```

**HTML entities**  
```{r}
knitr::include_graphics("HTML-entities.png")
```

[For more comprehensive list of HTML entities](http://unicode-table.com 2.2.5).  


## Tags and attributes  
### The anchor tag <a>  
The anchor tag <a> is what turns HTML from just a markup language into a hypertext markup language by enabling HTML documents to link to other documents. Much of the site-to-site navigation in browsers works via anchor elements.  

In fact, <a> elements are even more flexible as they can not only link to other files, but also link to specific parts of a document.  

### The metadata tag <meta>  
The <meta> tag is an empty tag written in the head element of an HTML document. <meta> elements do not have to be closed and thus differ from the general rule that empty elements have to be closed with a dash /.  

### The external reference tag <link>  
The link tag is used to link to and include information and external files. All information is provided with attributes.  

### Emphasizing tags <b>, <i>, <strong>  
Tags like <b>, <i>, <strong> are layout tags that refer to bold, italics, and strong emphasis.  

### The paragraphs tag <p>  
The <p> tag labels its content as being a paragraph and ensures that line breaks are inserted <p> before and after its content.  

### Heading tags <h1>, <h2>, <h3>, ...  
In order to define levels of headlines - level 1 to level 6 --HTML provides a series of tags <h1>, <h2>, ... down to <h6>.  

### Listing content with <ul>, <ol>, and <dl>  
Several tags exist to list content. They are used depending on whether they wrap around an ordered list (<ol>), an unordered list (ul), or a description list (<dl>). The former two tags make use of nested <li> elements to define list items, while the latter needs two further elements: <dt> for keyword and <dd> for its description.  

### The organizational tags <div> and <span>  
Another way of defining the appearance of parts of the HTML document are the <div> and <span> tags. While <div> and <span> themselves do not change the appearance of the content they enclose, these tags are used to group parts of the document—the former is used to define groups across lines, tags, and paragraphs, while the latter is used for in-line grouping.  

Grouping parts of an HTML document is handy when combined with Cascading Style
Sheets (CSS), a language for describing the layout of HTML and other markup documents like XML, SVG, and XHTML.  

The purpose ofCSS is to separate content from layout to improve the document’s accessi-
bility. Defining styles outside ofan HTML and assigning them via the class attribute enables the web designer to reuse styles across elements and documents. This enables developers to change a style in one single place—within the CSS file—with effects on all elements and documents using this style.  

### The <form> tag and its companions  
An advanced feature of HTML are forms. HTML forms do more than just layout content. They enable users to interact with servers by sending data to them instead of only receiving data from them.  

```
<form name="submitPW" action="Passed.html" method="get">
password:
        <input name="pw" type="text" value="">
        <input type="submit" value="SubmitButtonText">
</form>
```

The form in the example consists of one <form> element and two <input> elements nested within the former. The <form> tag has a name attribute, an action attribute, and a specific method. The name of the form servers as an internal identifier. The action and method attributes define what the browser is supposed to do once *submit button* is pressed. action defines the location of the response.  

The most common protocol for requesting and receiving resources on the Web is HTTP (Hypertext Transfer Protocol). The `method` attribute refers to the HTTP method that is used to send the information to the server. Most likely it will be POST or GET.  


### The foreign script tag <script>  
HTML itself is not a programming language. HTML is a markup language that describes content and defines its presentation. Once an HTML file is loaded in the browser, it remains stable and does not change by events or user interaction.  

The <script> element is a container for scripts that enable HTML to include functionality from other programming languages. This other language will frequently be JavaScript. JavaScript allows the browser to change the content and structure of the document after it has been loaded from the server, enabling user interaction and event handling.  


### Table tags <table>, <tr>, <td>, and <th>  
```
	 <table>
	 <tr> <th>Rank</th> <th>Nominal GDP</th> <th>Name</th> </tr>
 	 <tr> <th></th> <th>(per capita, USD)</th> <th></th> </tr>
	 <tr> <td>1</td> <td>170,373</td> <td>Lichtenstein</td> </tr>
	 <tr> <td>2</td> <td>167,021</td> <td>Monaco</td> </tr>
 	 <tr> <td>3</td> <td>115,377</td> <td>Luxembourg</td> </tr>
	 <tr> <td>4</td> <td>98,565</td> <td>Norway</td> </tr>
         <tr> <td>5</td> <td>92,682</td> <td>Qatar</td> </tr>
	 </table>
```


## Parsing  
Parsing HTML occurs at both steps—by the browser to display HTML content nicely, and also by parsers in R to construct useful representations ofHTML documents in our programming environment.  


### What is parsing  
The difference between reading and parsing is not just a semantic one. Instead, reading functions differ from parsing functions in that the former do not care to understand the formal grammar that underlies HTML but merely recognize the sequence of symbols included in the HTML file.  

```{r}
fortunes <- readLines(con = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html")
fortunes
```

```{r}
parsed_fortunes <- htmlParse(file = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html")
parsed_fortunes
```

### Discarding nodes  
Discarding unnecessary parts ofweb documents in the parsing stage can help mitigate memory issues and enhance extraction speed. Handlers provide a comfortable way to manipulate (i.e., delete, add, modify) nodes in the tree construction stage.  

```{r}
h1 <- list("body" = function(x) {NULL})
parsed_fortunes <- htmlTreeParse(file = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html", 
                                 handlers = h1, 
                                 asTree = T)

parsed_fortunes
```

```{r}
h1 <- list("div" = function(x)NULL, 
           "title" = function(x)NULL)

parsed_fortunes <- htmlTreeParse(file = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html", 
                                 handlers = h1, 
                                 asTree = T)
parsed_fortunes
```

```{r}
knitr::include_graphics("figures/generic-handlers-for-DOM-style-parsing.png")
```


```{r}
h2 <- list(
        startElement = function(node, ...){
                name = xmlName(node)
                if(name %in% c("div", "title")){
                        NULL
                }else{
                        node
                }
        }, 
        comment = function(node){
                NULL
        }
)


parsed_fortunes <- htmlTreeParse(file = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html", 
                                 handlers = h2, 
                                 asTree = T)

parsed_fortunes
```


### Extracting information in the building process  
```{r}
getItalics <- function(){
        i_container = character()
        list(i = function(node, ...){
                i_container <<- c(i_container, xmlValue(node))
        }, 
        returnI = function(){
                i_container
        })
}
```


```{r}
h3 <- getItalics()
```

```{r}
htmlTreeParse(file = "/home/yincy/git/Wiley-ADCR/ch-2-html/fortunes.html", 
              handlers = h3) %>% 
        invisible()

h3$returnI()
```


# Chapter 3 XML and JSON  
## XML syntax rules  
### Elements and attributes  
**XML declaration**  
```
<?xml version=1.0 encoding="ISO-8859-1"?>
```

**root element**
An XML file must contain one and only one root element that embraces the whole document.  


**element syntax**

Information is usually stored in elements. An XML element is defined by its start tag and the content. An element frequently has an end tag, but can also be closed in the start tag with aslash /.  

- *other elements*  
- *attributes*, bits of information that describe the element in more detail. Attributes, like elements, are slots for information, but they cannot contain further elements or attributes.  
- *data* of any form any length, for example, text, numbers or symbols.  
- *a mixture of everything*, which sounds complicated but is a rather ordinary case when elements contain other elements that contain data.  
- *nothing*, which means really nothing - no data, no other element, not even white spaces.  












































